# üöÄ SSO - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

> ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û!** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤!  
> **–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –¢–æ–∫–µ–Ω—ã —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –§–ê–ô–õ–ê–• –≤–º–µ—Å—Ç–æ —Å–µ—Å—Å–∏–π (–º–µ–∂—Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ $_SESSION).  
> **–¢—Ä–µ–±—É–µ—Ç—Å—è:** –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `/upload/loyalty_tokens/` —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –∑–∞–ø–∏—Å—å.

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

- ‚úÖ Frontend —Å –∫–Ω–æ–ø–∫–æ–π "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ú–æ–π –î–æ–∫—Ç–æ—Ä"
- ‚úÖ Backend API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç-based SSO (–±–µ–∑ –ø—Ä–æ–±–ª–µ–º —Å CORS)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ PHP —Å–µ—Å—Å–∏–π (session_start)

## üìÅ –§–∞–π–ª—ã –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ Bitrix

–ù—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å **2 —Ñ–∞–π–ª–∞** –Ω–∞ —Å–µ—Ä–≤–µ—Ä Bitrix:

### 1. –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)

**`loyalty_redirect.php`** ‚Üí `/local/pages/loyalty_redirect.php`

–°–∫–∞—á–∞—Ç—å: [bitrix_files/loyalty_redirect.php](bitrix_files/loyalty_redirect.php)

### 2. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª

**`verify_token.php`** ‚Üí `/local/api/verify_token.php`

–°–∫–∞—á–∞—Ç—å: [bitrix_files/verify_token.php](bitrix_files/verify_token.php)

---

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (1 –º–∏–Ω—É—Ç–∞)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ wget (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ Bitrix:

# 1. –°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p /var/www/html/local/pages
mkdir -p /var/www/html/local/api
mkdir -p /var/www/html/upload/loyalty_tokens

# 2. –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª—ã —Å GitHub
cd /var/www/html/local/pages/
wget -O loyalty_redirect.php https://raw.githubusercontent.com/gr33njj/mydoc-loyalty/main/bitrix_files/loyalty_redirect.php

cd /var/www/html/local/api/
wget -O verify_token.php https://raw.githubusercontent.com/gr33njj/mydoc-loyalty/main/bitrix_files/verify_token.php

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∞
chmod 644 /var/www/html/local/pages/loyalty_redirect.php
chmod 644 /var/www/html/local/api/verify_token.php
chmod 777 /var/www/html/upload/loyalty_tokens
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –°–∫–∞—á–∞—Ç—å –≤—Ä—É—á–Ω—É—é

–°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª—ã –ø–æ –ø—Ä—è–º—ã–º —Å—Å—ã–ª–∫–∞–º:

1. **loyalty_redirect.php:**  
   https://raw.githubusercontent.com/gr33njj/mydoc-loyalty/main/bitrix_files/loyalty_redirect.php  
   ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `/var/www/html/local/pages/`

2. **verify_token.php:**  
   https://raw.githubusercontent.com/gr33njj/mydoc-loyalty/main/bitrix_files/verify_token.php  
   ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `/var/www/html/local/api/`

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä—è–º–æ–π —Ä–µ–¥–∏—Ä–µ–∫—Ç

1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Bitrix: https://mydoctorarmavir.ru
2. **–í —ç—Ç–æ–π –∂–µ –≤–∫–ª–∞–¥–∫–µ** –æ—Ç–∫—Ä–æ–π—Ç–µ:  
   https://mydoctorarmavir.ru/local/pages/loyalty_redirect.php
3. –î–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ it-mydoc.ru —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π ‚úÖ

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://it-mydoc.ru/login
2. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ú–æ–π –î–æ–∫—Ç–æ—Ä"
3. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚úÖ

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    ‚Üì
it-mydoc.ru/login (–Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É)
    ‚Üì
mydoctorarmavir.ru/local/pages/loyalty_redirect.php
    ‚Üì (Bitrix –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)
    ‚Üì (–°–æ–∑–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω)
    ‚Üì (–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –§–ê–ô–õ /upload/loyalty_tokens/XXX.json)
    ‚Üì
it-mydoc.ru/auth/sso?token=XXX
    ‚Üì (Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –Ω–∞ backend)
    ‚Üì
Backend ‚Üí POST mydoctorarmavir.ru/verify_token.php
    ‚Üì (–ß–∏—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ –§–ê–ô–õ–ê)
    ‚Üì (–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    ‚Üì
Backend —Å–æ–∑–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω
    ‚Üì
Frontend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç JWT
    ‚Üì
it-mydoc.ru/ ‚úÖ –ê–í–¢–û–†–ò–ó–û–í–ê–ù!
```

**–í–∞–∂–Ω–æ:** –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ñ–∞–π–ª–∞—Ö, —Ç.–∫. `verify_token.php` –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –æ—Ç –¥—Ä—É–≥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –±–µ–∑ cookies Bitrix.

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12 ‚Üí Console)
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   - `üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –æ—Ç Bitrix: XXX`
   - `üì• –û—Ç–≤–µ—Ç –æ—Ç backend: {...}`
   - `‚úÖ JWT —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω`

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

**"Not Found"** ‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ–∞–π–ª—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
- `/local/pages/loyalty_redirect.php` ‚úÖ
- `/local/api/verify_token.php` ‚úÖ

**"User not authorized"** ‚Üí –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Bitrix, –ø–æ—Ç–æ–º –ø—Ä–æ–±—É–π—Ç–µ SSO

**"Token expired"** ‚Üí –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤—É–µ—Ç 5 –º–∏–Ω—É—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞

---

## üìä –°—Ç–∞—Ç—É—Å

- ‚úÖ Frontend –≥–æ—Ç–æ–≤
- ‚úÖ Backend –≥–æ—Ç–æ–≤  
- ‚è≥ –ù—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 2 —Ñ–∞–π–ª–∞ –Ω–∞ Bitrix
- ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

---

## üìû –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∫–æ–Ω—Å–æ–ª–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏

