# üéÅ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–æ–Ω—É—Å–æ–≤ –∏–∑ Bitrix –≤ "–ú–æ—è ‚ù§ —Å–∫–∏–¥–∫–∞"

## üìã –û–±–∑–æ—Ä

–≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –±–∞–ª–∞–Ω—Å–∞ –±–æ–Ω—É—Å–æ–≤ –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ Bitrix (`https://mydoctorarmavir.ru/personal/bonuses/`) –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å "–ú–æ—è ‚ù§ —Å–∫–∏–¥–∫–∞".

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      API       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>  ‚îÇ                  ‚îÇ
‚îÇ  –ú–æ—è ‚ù§ —Å–∫–∏–¥–∫–∞   ‚îÇ  GET bonuses   ‚îÇ  Bitrix CMS      ‚îÇ
‚îÇ  (it-mydoc.ru)   ‚îÇ <‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ (mydoctorarmavir)‚îÇ
‚îÇ                  ‚îÇ   JSON         ‚îÇ                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã (Bitrix)
- ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

## üöÄ –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PHP API –Ω–∞ Bitrix

### 1.1 –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Bitrix

**–ü—É—Ç—å:** `/local/api/get_bonuses.php`  
**URL:** `https://mydoctorarmavir.ru/local/api/get_bonuses.php`

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ñ–∞–π–ª–∞ `bitrix_files/get_bonuses.php`:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ Bitrix:
cd /var/www/html/local/api/
nano get_bonuses.php
# –í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ bitrix_files/get_bonuses.php
chmod 644 get_bonuses.php
```

### 1.2 –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è —Å –±–æ–Ω—É—Å–∞–º–∏

**–í–ê–ñ–ù–û!** –í–∞–º –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å, –≤ –∫–∞–∫–æ–º –ø–æ–ª–µ Bitrix —Ö—Ä–∞–Ω–∏—Ç –±–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –ë–î Bitrix:**
   ```sql
   SELECT * FROM b_user WHERE ID = 1;
   ```

2. **–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª–µ —Å –±–æ–Ω—É—Å–∞–º–∏:**
   –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:
   - `UF_BONUS_BALANCE`
   - `UF_BONUS_POINTS`
   - `UF_LOYALTY_BALANCE`
   - `UF_BONUSES`

3. **–û–±–Ω–æ–≤–∏—Ç–µ `get_bonuses.php`:**
   –ó–∞–º–µ–Ω–∏—Ç–µ –≤ –∫–æ–¥–µ:
   ```php
   if (isset($user['UF_BONUS_BALANCE'])) {  // ‚Üê –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!
       $bonusBalance = floatval($user['UF_BONUS_BALANCE']);
   }
   ```

### 1.3 –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ë–æ–Ω—É—Å—ã –≤ –º–æ–¥—É–ª–µ Sale

–ï—Å–ª–∏ –±–æ–Ω—É—Å—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –º–æ–¥—É–ª–µ Sale (—Å—á–µ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è), —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤ `get_bonuses.php`:

```php
$accounts = \Bitrix\Sale\Internals\UserAccountTable::getList([
    'filter' => [
        'USER_ID' => $userId,
        'CURRENCY' => 'RUB'
    ]
])->fetch();

if ($accounts) {
    $bonusBalance = floatval($accounts['CURRENT_BUDGET']);
}
```

### 1.4 –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API

```bash
# –¢–µ—Å—Ç 1: –ß–µ—Ä–µ–∑ curl
curl -X POST https://mydoctorarmavir.ru/local/api/get_bonuses.php \
  -H "Content-Type: application/json" \
  -d '{"user_id": 1}'

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
# {"success":true,"user_id":"1","bonus_balance":150.50,"currency":"RUB"}
```

```bash
# –¢–µ—Å—Ç 2: –ß–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä
https://mydoctorarmavir.ru/local/api/get_bonuses.php?user_id=1
```

---

## üîß –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Backend –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞

### 2.1 –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend

```bash
cd /tmp/mydoc-loyalty
docker-compose restart backend
```

### 2.2 –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤—ã–π endpoint

```bash
# –ü–æ–ª—É—á–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω (–∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ SSO)
# –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint:

curl -X GET https://it-mydoc.ru/api/auth/bitrix/bonus-balance \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
# {
#   "success": true,
#   "bonus_balance": 150.50,
#   "currency": "RUB",
#   "source": "bitrix"
# }
```

---

## üé® –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Frontend

### 3.1 –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ Dashboard

–û—Ç–∫—Ä–æ–π—Ç–µ `frontend/src/pages/Dashboard.js` –∏ –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞ –∏–∑ Bitrix:

```javascript
const [bitrixBalance, setBitrixBalance] = useState(null);
const [loadingBitrix, setLoadingBitrix] = useState(true);

useEffect(() => {
  const fetchBitrixBalance = async () => {
    try {
      const response = await axios.get('/auth/bitrix/bonus-balance');
      if (response.data.success) {
        setBitrixBalance(response.data.bonus_balance);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∏–∑ Bitrix:', error);
    } finally {
      setLoadingBitrix(false);
    }
  };

  fetchBitrixBalance();
}, []);
```

### 3.2 –û—Ç–æ–±—Ä–∞–∑–∏—Ç–µ –±–∞–ª–∞–Ω—Å –∏–∑ Bitrix

```javascript
<Card>
  <CardContent>
    <Box display="flex" alignItems="center" mb={2}>
      <AccountBalanceWalletIcon sx={{ fontSize: 40, color: 'primary.main', mr: 2 }} />
      <Box>
        <Typography variant="h6" color="text.secondary">
          –ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã
        </Typography>
        <Typography variant="h4" fontWeight="bold" color="primary.main">
          {loadingBitrix ? (
            <CircularProgress size={24} />
          ) : (
            `${bitrixBalance?.toFixed(2) || '0.00'} ‚ÇΩ`
          )}
        </Typography>
        <Typography variant="caption" color="text.secondary">
          –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –ú–æ–π –î–æ–∫—Ç–æ—Ä
        </Typography>
      </Box>
    </Box>
  </CardContent>
</Card>
```

### 3.3 –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É Loyalty

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç–µ `frontend/src/pages/Loyalty.js`:

```javascript
// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ fetchLoyaltyData:
const bitrixResponse = await axios.get('/auth/bitrix/bonus-balance');
if (bitrixResponse.data.success) {
  setLoyaltyData(prev => ({
    ...prev,
    balance: bitrixResponse.data.bonus_balance,
    source: 'bitrix'
  }));
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API Bitrix

```bash
curl -X POST https://mydoctorarmavir.ru/local/api/get_bonuses.php \
  -H "Content-Type: application/json" \
  -d '{"user_id": 1}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "user_id": "1",
  "bonus_balance": 150.50,
  "currency": "RUB"
}
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ SSO: https://it-mydoc.ru/login
2. –û—Ç–∫—Ä–æ–π—Ç–µ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Console (F12):**
   ```javascript
   // –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –ª–æ–≥–∏:
   üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –±–æ–Ω—É—Å–æ–≤ –∏–∑ Bitrix...
   ‚úÖ –ë–∞–ª–∞–Ω—Å: 150.50 ‚ÇΩ
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network (F12):**
   - –ù–∞–π–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å: `GET /api/auth/bitrix/bonus-balance`
   - –°—Ç–∞—Ç—É—Å: `200 OK`
   - Response: `{"success":true,"bonus_balance":150.50,...}`

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend

```bash
docker-compose logs backend 2>&1 | grep -E "(üí∞|üì•|‚úÖ)" | tail -20
```

**–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:**
```
üí∞ –ó–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞ –±–æ–Ω—É—Å–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: bitrix_id=1
üì• –û—Ç–≤–µ—Ç Bitrix: {'success': True, 'bonus_balance': 150.5, ...}
‚úÖ –ë–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤ –ø–æ–ª—É—á–µ–Ω: 150.5 —Ä—É–±.
```

---

## üìä –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

### –í–∞—Ä–∏–∞–Ω—Ç 1: –¢–æ–ª—å–∫–æ Bitrix (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã              ‚îÇ
‚îÇ  150.50 ‚ÇΩ                    ‚îÇ
‚îÇ  –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Bitrix + –õ–æ–∫–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã              ‚îÇ
‚îÇ  üìç Bitrix: 150.50 ‚ÇΩ         ‚îÇ
‚îÇ  üí≥ –õ–æ–∫–∞–ª—å–Ω–æ: 50.00 –±–∞–ª–ª–æ–≤   ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  –ò—Ç–æ–≥–æ: 200.50               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –° –∫–Ω–æ–ø–∫–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã       üîÑ     ‚îÇ
‚îÇ  150.50 ‚ÇΩ                    ‚îÇ
‚îÇ  –û–±–Ω–æ–≤–ª–µ–Ω–æ: 10:30            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–í `get_bonuses.php` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã CORS:
```php
header('Access-Control-Allow-Origin: https://it-mydoc.ru');
header('Access-Control-Allow-Credentials: true');
```

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `bitrix_id` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ SSO, –ø–æ—ç—Ç–æ–º—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

**–û–¥–Ω–∞–∫–æ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**

```php
// –í get_bonuses.php –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞:
$token = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
if (empty($token) || !preg_match('/Bearer\s(\S+)/', $token, $matches)) {
    http_response_code(401);
    echo json_encode(['success' => false, 'error' => 'Unauthorized']);
    exit;
}

// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: `{"success":false,"bonus_balance":0}`

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è —Å –±–æ–Ω—É—Å–∞–º–∏.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î Bitrix:
   ```sql
   SHOW COLUMNS FROM b_user LIKE 'UF_%';
   ```
2. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª–µ —Å –±–æ–Ω—É—Å–∞–º–∏
3. –û–±–Ω–æ–≤–∏—Ç–µ `get_bonuses.php`

---

### –ü—Ä–æ–±–ª–µ–º–∞: CORS –æ—à–∏–±–∫–∞

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ `get_bonuses.php`:
```php
header('Access-Control-Allow-Origin: https://it-mydoc.ru');
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∏—Ç—Ä–∏–∫—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `"bonus_balance":0` –¥–ª—è –≤—Å–µ—Ö

**–ü—Ä–∏—á–∏–Ω–∞:** –ë–æ–Ω—É—Å—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–µ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–æ–ª—è—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –±–ª–æ–∫ —Å –º–æ–¥—É–ª–µ–º Sale –≤ `get_bonuses.php`:
```php
$accounts = \Bitrix\Sale\Internals\UserAccountTable::getList([
    'filter' => ['USER_ID' => $userId, 'CURRENCY' => 'RUB']
])->fetch();
```

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis

–î–æ–±–∞–≤—å—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Bitrix:

```python
# –í backend/routers/bitrix_sso.py
import redis

redis_client = redis.from_url(settings.REDIS_URL)

@router.get("/bonus-balance")
async def get_bitrix_bonus_balance(...):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    cache_key = f"bitrix:bonus:{current_user.bitrix_id}"
    cached = redis_client.get(cache_key)
    
    if cached:
        return json.loads(cached)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–∑ Bitrix...
    result = {...}
    
    # –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç
    redis_client.setex(cache_key, 300, json.dumps(result))
    
    return result
```

### 2. Webhook –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ Bitrix –æ—Ç–ø—Ä–∞–≤–∫—É webhook –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞:

```php
// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤:
$ch = curl_init('https://it-mydoc.ru/api/integrations/bitrix-bonus-changed');
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode([
    'user_id' => $userId,
    'new_balance' => $newBalance
]));
curl_exec($ch);
```

### 3. –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞

–ü–æ–ª—É—á–∞–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–∑ Bitrix:

```php
// /local/api/get_bonus_history.php
$history = \Bitrix\Sale\Internals\AccountTransactionTable::getList([
    'filter' => ['USER_ID' => $userId],
    'order' => ['TIMESTAMP_X' => 'DESC'],
    'limit' => 10
]);
```

---

## ‚úÖ Checklist –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

- [ ] –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `/local/api/get_bonuses.php` –Ω–∞ Bitrix
- [ ] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è —Å –±–æ–Ω—É—Å–∞–º–∏
- [ ] API –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ curl
- [ ] Backend –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] Endpoint `/api/auth/bitrix/bonus-balance` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Frontend –æ–±–Ω–æ–≤–ª–µ–Ω (Dashboard + Loyalty)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ
- [ ] CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- [ ] –ë–∞–ª–∞–Ω—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ UI

---

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:

‚úÖ **Dashboard** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ Bitrix  
‚úÖ **–°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ë–æ–Ω—É—Å—ã"** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã  
‚úÖ **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã** - Bitrix  
‚úÖ **–ù–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏** –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏  

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend: `docker-compose logs backend | tail -50`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Console –≤ –±—Ä–∞—É–∑–µ—Ä–µ (F12)
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ API Bitrix –æ—Ç–≤–µ—á–∞–µ—Ç: `curl ...`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è —Å –±–æ–Ω—É—Å–∞–º–∏ –≤ –ë–î

