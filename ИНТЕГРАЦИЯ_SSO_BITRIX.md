# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SSO —Å Bitrix CMS

## –û–±–∑–æ—Ä

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –ª–∏—á–Ω—ã–º –∫–∞–±–∏–Ω–µ—Ç–æ–º Bitrix –Ω–∞ —Å–∞–π—Ç–µ https://mydoctorarmavir.ru

## –í–∞—Ä–∏–∞–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: OAuth 2.0 —á–µ—Ä–µ–∑ Bitrix REST API (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª
- ‚úÖ –í—ã—Å–æ–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ –ù–∞—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ Bitrix
- ‚úÖ Refresh —Ç–æ–∫–µ–Ω—ã

**–°—Ö–µ–º–∞:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ mydoctorarmavir.ru ‚Üí –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ Bitrix
2. Bitrix —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ it-mydoc.ru —Å authorization_code
3. –ù–∞—à –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ access_token
4. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Bitrix REST API
5. –°–æ–∑–¥–∞–µ–º/–Ω–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—à–µ–π –ë–î
6. –í—ã–¥–∞–µ–º JWT —Ç–æ–∫–µ–Ω –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Webhook –æ—Ç Bitrix (–ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Bitrix (—Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ API

**–°—Ö–µ–º–∞:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ Bitrix
2. Bitrix –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ –Ω–∞—à endpoint —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ú—ã —Å–æ–∑–¥–∞–µ–º JWT —Ç–æ–∫–µ–Ω –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –õ–ö
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ï–¥–∏–Ω–∞—è —Å–µ—Å—Å–∏—è —á–µ—Ä–µ–∑ Cookie (–ë—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–°—Ö–µ–º–∞:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ Bitrix (mydoctorarmavir.ru)
2. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –õ–ö –¥–æ–±–∞–≤–ª—è–µ–º iframe/—Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–∞—à endpoint
3. Endpoint –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é Bitrix —á–µ—Ä–µ–∑ REST API
4. –°–æ–∑–¥–∞–µ–º JWT —Ç–æ–∫–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
```

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: OAuth 2.0

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Bitrix

#### –°–æ–∑–¥–∞–Ω–∏–µ OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Bitrix:

1. –í–æ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Bitrix: https://mydoctorarmavir.ru/bitrix/admin/
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞** ‚Üí **OAuth-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
   - **–ù–∞–∑–≤–∞–Ω–∏–µ**: –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ MyDoc
   - **Redirect URI**: `https://it-mydoc.ru/auth/bitrix/callback`
   - **–ü—Ä–∞–≤–∞**: `user` (—á—Ç–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ:
   - `CLIENT_ID`
   - `CLIENT_SECRET`

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Bitrix:

–í —à–∞–±–ª–æ–Ω–µ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ (`/local/templates/your_template/header.php`):

```php
<?php
// –ö–Ω–æ–ø–∫–∞ "–ú–æ—è ‚ù§ —Å–∫–∏–¥–∫–∞" –≤ –º–µ–Ω—é –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
?>
<a href="https://it-mydoc.ru/auth/bitrix/login" class="loyalty-link">
    <span class="icon">‚ù§Ô∏è</span> –ú–æ—è —Å–∫–∏–¥–∫–∞
</a>
```

### 2. Backend: –ù–æ–≤—ã–µ endpoints –¥–ª—è SSO

–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª `backend/routers/bitrix_sso.py`:

```python
from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.responses import RedirectResponse
from sqlalchemy.orm import Session
import httpx
import secrets
from datetime import datetime, timedelta

from database import get_db
from models import User
from routers.auth import create_access_token, get_password_hash
from config import settings

router = APIRouter(prefix="/auth/bitrix", tags=["Bitrix SSO"])

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Bitrix OAuth
BITRIX_DOMAIN = "https://mydoctorarmavir.ru"
BITRIX_CLIENT_ID = settings.bitrix_client_id  # –ò–∑ .env
BITRIX_CLIENT_SECRET = settings.bitrix_client_secret  # –ò–∑ .env
BITRIX_REDIRECT_URI = "https://it-mydoc.ru/auth/bitrix/callback"

# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è state (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis)
oauth_states = {}


@router.get("/login")
async def bitrix_login():
    """–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é Bitrix"""
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π state –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF
    state = secrets.token_urlsafe(32)
    oauth_states[state] = datetime.utcnow()
    
    # URL –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Bitrix
    auth_url = (
        f"{BITRIX_DOMAIN}/oauth/authorize/"
        f"?client_id={BITRIX_CLIENT_ID}"
        f"&response_type=code"
        f"&redirect_uri={BITRIX_REDIRECT_URI}"
        f"&state={state}"
    )
    
    return RedirectResponse(url=auth_url)


@router.get("/callback")
async def bitrix_callback(
    code: str,
    state: str,
    db: Session = Depends(get_db)
):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback –æ—Ç Bitrix OAuth"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º state
    if state not in oauth_states:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Invalid state parameter"
        )
    
    # –£–¥–∞–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π state
    del oauth_states[state]
    
    # –û–±–º–µ–Ω–∏–≤–∞–µ–º code –Ω–∞ access_token
    async with httpx.AsyncClient() as client:
        token_response = await client.post(
            f"{BITRIX_DOMAIN}/oauth/token/",
            data={
                "grant_type": "authorization_code",
                "client_id": BITRIX_CLIENT_ID,
                "client_secret": BITRIX_CLIENT_SECRET,
                "code": code,
                "redirect_uri": BITRIX_REDIRECT_URI,
            }
        )
        
        if token_response.status_code != 200:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Failed to exchange code for token"
            )
        
        token_data = token_response.json()
        access_token = token_data["access_token"]
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Bitrix
        user_response = await client.get(
            f"{BITRIX_DOMAIN}/rest/user.current.json",
            params={"auth": access_token}
        )
        
        if user_response.status_code != 200:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Failed to get user info"
            )
        
        bitrix_user = user_response.json()["result"]
    
    # –ò—â–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—à–µ–π –ë–î
    user = db.query(User).filter(
        User.email == bitrix_user["EMAIL"]
    ).first()
    
    if not user:
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = User(
            email=bitrix_user["EMAIL"],
            full_name=f'{bitrix_user.get("NAME", "")} {bitrix_user.get("LAST_NAME", "")}'.strip(),
            phone=bitrix_user.get("PERSONAL_PHONE", ""),
            password_hash=get_password_hash(secrets.token_urlsafe(32)),  # –°–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–æ–ª—å
            role="patient",
            bitrix_id=bitrix_user["ID"]  # –î–æ–±–∞–≤–∏–º –ø–æ–ª–µ bitrix_id –≤ –º–æ–¥–µ–ª—å
        )
        db.add(user)
        db.commit()
        db.refresh(user)
    
    # –°–æ–∑–¥–∞–µ–º JWT —Ç–æ–∫–µ–Ω –¥–ª—è –Ω–∞—à–µ–≥–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞
    jwt_token = create_access_token(data={"sub": str(user.id)})
    
    # –†–µ–¥–∏—Ä–µ–∫—Ç–∏–º –≤ –õ–ö —Å —Ç–æ–∫–µ–Ω–æ–º
    redirect_url = f"https://it-mydoc.ru/?token={jwt_token}"
    
    return RedirectResponse(url=redirect_url)


@router.post("/webhook")
async def bitrix_webhook(
    user_data: dict,
    db: Session = Depends(get_db)
):
    """Webhook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Bitrix"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å –∑–∞–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # signature = request.headers.get("X-Bitrix-Signature")
    # verify_signature(signature, user_data)
    
    email = user_data.get("email")
    if not email:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Email is required"
        )
    
    # –ò—â–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = db.query(User).filter(User.email == email).first()
    
    if not user:
        user = User(
            email=email,
            full_name=user_data.get("full_name", ""),
            phone=user_data.get("phone", ""),
            password_hash=get_password_hash(secrets.token_urlsafe(32)),
            role="patient",
            bitrix_id=user_data.get("bitrix_id")
        )
        db.add(user)
        db.commit()
        db.refresh(user)
    
    # –°–æ–∑–¥–∞–µ–º JWT —Ç–æ–∫–µ–Ω
    jwt_token = create_access_token(data={"sub": str(user.id)})
    
    return {
        "success": True,
        "token": jwt_token,
        "user_id": user.id
    }
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ User

–î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ `bitrix_id` –≤ `backend/models.py`:

```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True, index=True)
    phone = Column(String, unique=True, index=True, nullable=True)
    password_hash = Column(String)
    full_name = Column(String)
    role = Column(Enum(UserRole), default=UserRole.PATIENT)
    is_active = Column(Boolean, default=True)
    bitrix_id = Column(String, unique=True, index=True, nullable=True)  # –ù–û–í–û–ï!
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–î–æ–±–∞–≤–ª—è–µ–º –≤ `backend/config.py`:

```python
class Settings(BaseSettings):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ...
    
    # Bitrix OAuth
    bitrix_client_id: str
    bitrix_client_secret: str
    
    class Config:
        env_file = ".env"
```

–î–æ–±–∞–≤–ª—è–µ–º –≤ `.env`:

```env
BITRIX_CLIENT_ID=your_client_id_from_bitrix
BITRIX_CLIENT_SECRET=your_client_secret_from_bitrix
```

### 5. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–∞

–í `backend/main.py`:

```python
from routers import loyalty, certificates, referrals, auth, admin, integrations, bitrix_sso

# ...

app.include_router(bitrix_sso.router)
```

### 6. Frontend: –û–±—Ä–∞–±–æ—Ç–∫–∞ SSO —Ç–æ–∫–µ–Ω–∞

–û–±–Ω–æ–≤–ª—è–µ–º `frontend/src/context/AuthContext.js`:

```javascript
useEffect(() => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL (SSO —Ä–µ–¥–∏—Ä–µ–∫—Ç)
  const urlParams = new URLSearchParams(window.location.search);
  const ssoToken = urlParams.get('token');
  
  if (ssoToken) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
    localStorage.setItem('token', ssoToken);
    setToken(ssoToken);
    
    // –û—á–∏—â–∞–µ–º URL –æ—Ç —Ç–æ–∫–µ–Ω–∞
    window.history.replaceState({}, document.title, '/');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    fetchCurrentUser();
  } else {
    // –û–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
    const storedToken = localStorage.getItem('token');
    if (storedToken) {
      setToken(storedToken);
      fetchCurrentUser();
    }
  }
}, []);
```

---

## –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

–°–æ–∑–¥–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `bitrix_id`:

```bash
cd /tmp/mydoc-loyalty/backend
alembic revision -m "add bitrix_id to users"
```

–í —Å–æ–∑–¥–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

```python
def upgrade():
    op.add_column('users', sa.Column('bitrix_id', sa.String(), nullable=True))
    op.create_index(op.f('ix_users_bitrix_id'), 'users', ['bitrix_id'], unique=True)

def downgrade():
    op.drop_index(op.f('ix_users_bitrix_id'), table_name='users')
    op.drop_column('users', 'bitrix_id')
```

–ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é:

```bash
docker exec -it mydoc_backend alembic upgrade head
```

---

## –°—Ö–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–ò—Ç–æ–≥–æ–≤–∞—è)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  mydoctorarmavir.ru                         ‚îÇ
‚îÇ                    (Bitrix CMS)                             ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ  üë§ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤                          ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  üìß ivan@example.com                     ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ                                          ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  [‚ù§Ô∏è –ú–æ—è —Å–∫–∏–¥–∫–∞] ‚Üê –°—Å—ã–ª–∫–∞ –Ω–∞ SSO        ‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                      ‚Üì (–∫–ª–∏–∫)                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         it-mydoc.ru/auth/bitrix/login                       ‚îÇ
‚îÇ         (–ù–∞—à –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å)                                   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç state –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ Bitrix OAuth             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    mydoctorarmavir.ru/oauth/authorize                       ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏              ‚îÇ
‚îÇ  —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç —Å authorization_code                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    it-mydoc.ru/auth/bitrix/callback?code=XXX&state=YYY      ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç state                                         ‚îÇ
‚îÇ  2. –û–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ access_token                         ‚îÇ
‚îÇ  3. –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Bitrix REST API         ‚îÇ
‚îÇ  4. –°–æ–∑–¥–∞–µ—Ç/–Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î                       ‚îÇ
‚îÇ  5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω                                    ‚îÇ
‚îÇ  6. –†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –≤ –õ–ö: it-mydoc.ru/?token=JWT_TOKEN          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              it-mydoc.ru (–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç)                   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ URL                                  ‚îÇ
‚îÇ  2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ localStorage                                ‚îÇ
‚îÇ  3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                           ‚îÇ
‚îÇ  4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞—à–±–æ—Ä–¥ —Å –±–æ–Ω—É—Å–∞–º–∏ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—á–µ—Ä–µ–∑ ngrok):

```bash
# –ó–∞–ø—É—Å–∫–∞–µ–º ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
ngrok http 8000

# –ò—Å–ø–æ–ª—å–∑—É–µ–º URL –∏–∑ ngrok –∫–∞–∫ redirect_uri –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Bitrix
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://mydoctorarmavir.ru
2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
3. –ù–∞–∂–º–∏—Ç–µ "–ú–æ—è ‚ù§ —Å–∫–∏–¥–∫–∞"
4. –î–æ–ª–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ it-mydoc.ru —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. PKCE (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π):

```python
import hashlib
import base64

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è code_verifier –∏ code_challenge
code_verifier = secrets.token_urlsafe(32)
code_challenge = base64.urlsafe_b64encode(
    hashlib.sha256(code_verifier.encode()).digest()
).decode().rstrip('=')
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook:

```python
import hmac

def verify_bitrix_signature(signature: str, data: dict, secret: str) -> bool:
    expected_signature = hmac.new(
        secret.encode(),
        json.dumps(data, sort_keys=True).encode(),
        hashlib.sha256
    ).hexdigest()
    
    return hmac.compare_digest(signature, expected_signature)
```

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

‚úÖ **–ï–¥–∏–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π OAuth 2.0  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Bitrix  
‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã  

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü–æ–ª—É—á–∏—Ç–µ `CLIENT_ID` –∏ `CLIENT_SECRET` –∏–∑ Bitrix
2. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `backend/routers/bitrix_sso.py`
3. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ `bitrix_id` –≤ –º–æ–¥–µ–ª—å User
4. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
5. –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–æ–∫–µ–Ω–∞ –∏–∑ URL –≤–æ frontend
6. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Bitrix

–ì–æ—Ç–æ–≤–æ –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é! üöÄ

