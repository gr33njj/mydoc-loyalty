# ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ mydoc-loyalty

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

---

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ (Cron)

### 1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã** (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
- **–°–∫—Ä–∏–ø—Ç:** `/tmp/mydoc-loyalty/health-check.sh`
- **–õ–æ–≥:** `/var/log/mydoc-health-check.log`
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `*/5 * * * *`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –†–∞–±–æ—Ç—É –≤—Å–µ—Ö Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API (https://it-mydoc.ru/api/health)
- ‚úÖ –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ >85%)
- ‚úÖ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —É–ø–∞–≤—à–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —É–ø–∞–≤—à–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- –û—á–∏—â–∞–µ—Ç –¥–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –û–±–Ω–æ–≤–ª—è–µ—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –µ—Å–ª–∏ –∏—Å—Ç–µ–∫–∞–µ—Ç

---

### 2. **–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫** (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç)
- **–°–∫—Ä–∏–ø—Ç:** `/tmp/mydoc-loyalty/system-monitor.sh`
- **–õ–æ–≥:** `/var/log/mydoc-metrics.log`
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `*/15 * * * *`

**–°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏:**
- üìä CPU –∏ RAM –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- üíæ –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
- üê≥ –°—Ç–∞—Ç—É—Å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É (CPU/Memory)
- üíΩ –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ö†Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

---

### 3. **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 02:00)
- **–°–∫—Ä–∏–ø—Ç:** `/tmp/mydoc-loyalty/backup.sh`
- **–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** `/var/backups/mydoc-loyalty/`
- **–õ–æ–≥:** `/var/log/mydoc-backup.log`
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `0 2 * * *`

**–°–æ–∑–¥–∞–µ—Ç –±—ç–∫–∞–ø—ã:**
- üì¶ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL (—Å–∂–∞—Ç—ã–π SQL –¥–∞–º–ø)
- üìÅ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ `/uploads`
- üóëÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π

**–§–æ—Ä–º–∞—Ç –∏–º–µ–Ω:**
```
db_backup_YYYYMMDD_HHMMSS.sql.gz
uploads_backup_YYYYMMDD_HHMMSS.tar.gz
```

---

### 4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞** (–∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `0 */12 * * *`
- **–õ–æ–≥:** `/var/log/certbot-renew.log`

**–î–µ–π—Å—Ç–≤–∏—è:**
- üîê –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç nginx –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

### 5. **–û—á–∏—Å—Ç–∫–∞ Docker** (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ, –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 03:00)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `0 3 * * 0`
- **–õ–æ–≥:** `/var/log/docker-cleanup.log`

**–£–¥–∞–ª—è–µ—Ç:**
- üóëÔ∏è –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Docker –æ–±—Ä–∞–∑—ã (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
- üóëÔ∏è –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- üóëÔ∏è –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Docker volumes
- üóëÔ∏è Build cache

---

### 6. **–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫** (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 04:00)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `0 4 * * 1`
- **–õ–æ–≥:** `/var/log/mydoc-restart.log`

**–ü—Ä–∏—á–∏–Ω—ã:**
- üîÑ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- üîÑ –°–±—Ä–æ—Å –∫—ç—à–µ–π
- üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

---

## üê≥ Docker Health Checks

–í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–º–µ—é—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ health checks:

### PostgreSQL
```yaml
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U mydoc_user -d mydoc_loyalty"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

### Redis
```yaml
healthcheck:
  test: ["CMD", "redis-cli", "ping"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 10s
```

### Backend
```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s
```

**–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:** `restart: unless-stopped`
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
- –ù–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –µ—Å–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é

---

## üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

### –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
```bash
tail -f /var/log/mydoc-health-check.log
```

### –õ–æ–≥–∏ –º–µ—Ç—Ä–∏–∫
```bash
tail -f /var/log/mydoc-metrics.log
```

### –õ–æ–≥–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
tail -f /var/log/mydoc-backup.log
```

### –õ–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL
```bash
tail -f /var/log/certbot-renew.log
```

### –õ–æ–≥–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```bash
cd /tmp/mydoc-loyalty
docker-compose logs -f backend
docker-compose logs -f --tail=100 backend  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫
```

---

## üîß –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è –≤—Ä—É—á–Ω—É—é
```bash
/tmp/mydoc-loyalty/health-check.sh
```

### –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –≤—Ä—É—á–Ω—É—é
```bash
/tmp/mydoc-loyalty/backup.sh
```

### –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –≤—Ä—É—á–Ω—É—é
```bash
/tmp/mydoc-loyalty/system-monitor.sh
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
gunzip < /var/backups/mydoc-loyalty/db_backup_YYYYMMDD_HHMMSS.sql.gz | \
  docker exec -i mydoc_postgres psql -U mydoc_user mydoc_loyalty

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
tar -xzf /var/backups/mydoc-loyalty/uploads_backup_YYYYMMDD_HHMMSS.tar.gz -C /tmp/mydoc-loyalty/
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ cron –∑–∞–¥–∞—á
```bash
cat /etc/cron.d/mydoc-loyalty
systemctl status cron
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤—Ä—É—á–Ω—É—é
```bash
cd /tmp/mydoc-loyalty
docker-compose restart
docker-compose restart backend  # –¢–æ–ª—å–∫–æ backend
```

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –º–µ—Ç—Ä–∏–∫
```bash
tail -20 /var/log/mydoc-metrics.log
```

### –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º
```bash
# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
grep "ERROR" /var/log/mydoc-health-check.log

# –ü–æ–∏—Å–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º
grep "–ö–†–ò–¢–ò–ß–ù–û" /var/log/mydoc-health-check.log

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU
grep "CPU:" /var/log/mydoc-metrics.log | tail -20

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RAM
grep "RAM:" /var/log/mydoc-metrics.log | tail -20
```

---

## üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–∫—Ä–∏–ø—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫—É email –∏–ª–∏ Telegram:

### Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```bash
# –í health-check.sh –¥–æ–±–∞–≤–∏—Ç—å:
TELEGRAM_BOT_TOKEN="your_bot_token"
TELEGRAM_CHAT_ID="your_chat_id"

send_telegram() {
    curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
        -d chat_id="$TELEGRAM_CHAT_ID" \
        -d text="$1" > /dev/null
}

# –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ:
send_telegram "üö® –ö–†–ò–¢–ò–ß–ù–û: mydoc_backend –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å!"
```

---

## üìù –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤

–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –≤ `/etc/logrotate.d/mydoc-loyalty`:

- **–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è** –¥–ª—è –ª–æ–≥–æ–≤ health-check –∏ metrics
- **–•—Ä–∞–Ω–µ–Ω–∏–µ** –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 30 –¥–Ω–µ–π
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∂–∞—Ç–∏–µ** —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```bash
logrotate -d /etc/logrotate.d/mydoc-loyalty
```

–†—É—á–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è:
```bash
logrotate -f /etc/logrotate.d/mydoc-loyalty
```

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
```bash
chmod 600 /tmp/mydoc-loyalty/.env
chmod 600 /tmp/mydoc-loyalty/backend/.env
chmod 700 /tmp/mydoc-loyalty/*.sh
chmod 700 /var/backups/mydoc-loyalty
```

### –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
netstat -tulpn | grep -E ":(80|443|3000|5432|6379|8000)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
openssl x509 -in /etc/letsencrypt/live/it-mydoc.ru/fullchain.pem -noout -dates -subject

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Docker –æ–±—Ä–∞–∑–æ–≤
docker-compose pull
```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. ‚úÖ –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: `docker-compose ps`
2. ‚úÖ –õ–æ–≥–∏ health-check: `tail -f /var/log/mydoc-health-check.log`
3. ‚úÖ API: `curl https://it-mydoc.ru/api/health`
4. ‚úÖ –õ–æ–≥–∏ backend: `docker-compose logs backend | tail -50`

–í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `/tmp/mydoc-loyalty/`








